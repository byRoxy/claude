<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Claude AI Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background-color: #09090b; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #3f3f46; border-radius: 20px; }
        .prose pre { margin: 0; border-radius: 0.5rem; overflow: hidden; position: relative; }
        
        /* Kopyala Butonu */
        .copy-btn { 
            position: absolute; top: 8px; right: 8px; z-index: 10;
            background: rgba(255, 255, 255, 0.1); color: #e4e4e7;
            padding: 4px 8px; border-radius: 4px; font-size: 12px; backdrop-filter: blur(4px);
            cursor: pointer;
        }

        /* Sidebar Animasyon */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }

        /* Aktif Sohbet Rengi - Daha belirgin */
        .active-session { 
            background-color: rgba(99, 102, 241, 0.2) !important; 
            border-left: 3px solid #6366f1;
            color: white !important;
        }
    </style>
</head>
<body class="text-gray-200 font-sans antialiased">

    <div class="flex h-[100dvh] w-full relative">
        <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-20 hidden md:hidden"></div>

        <aside id="sidebar" class="absolute md:relative z-30 w-72 h-full bg-[#0c0c0e] border-r border-white/10 flex flex-col sidebar-transition sidebar-closed md:transform-none shadow-2xl md:shadow-none">
            
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <span class="font-bold text-lg bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">Claude AI</span>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>

            <div class="p-3">
                <button onclick="startNewChat()" class="w-full flex items-center gap-2 justify-center bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition font-medium text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Yeni Sohbet
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-2">
                <div class="text-xs font-semibold text-gray-500 px-3 py-2 uppercase tracking-wider">Ge√ßmi≈ü</div>
                <div id="session-list" class="space-y-1">
                    </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative bg-[#09090b] w-full">
            <div class="md:hidden flex items-center justify-between p-3 border-b border-white/10 bg-[#09090b] z-10">
                <button onclick="toggleSidebar()" class="text-gray-300 p-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
                <span class="font-bold text-sm text-gray-400 truncate max-w-[150px]" id="header-title">Yeni Sohbet</span>
                <div class="w-6"></div>
            </div>

            <div id="chat-box" class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 space-y-6 scroll-smooth">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center space-y-6 opacity-80">
                    <div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center text-3xl border border-white/5">üöÄ</div>
                    <h2 class="text-xl font-bold text-white">Yardƒ±ma hazƒ±r.</h2>
                </div>
            </div>

            <div class="flex-none p-3 md:p-5 bg-[#09090b] border-t border-white/5 w-full">
                <div class="max-w-3xl mx-auto relative bg-[#18181b] rounded-2xl border border-white/10 focus-within:border-indigo-500/50 shadow-lg">
                    <textarea id="user-input" rows="1" class="w-full bg-transparent text-white p-4 pr-14 max-h-32 focus:outline-none resize-none overflow-hidden text-[16px]" placeholder="Bir ≈üeyler yazƒ±n..." oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 120) + 'px'"></textarea>
                    <button onclick="sendMessage()" id="send-btn" class="absolute bottom-2 right-2 p-2 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white transition disabled:opacity-50">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        marked.setOptions({ highlight: (code) => hljs.highlightAuto(code).value, breaks: true });
        
        let currentSessionId = null;

        // --- SESSION Y√ñNETƒ∞Mƒ∞ ---
        
        async function loadSessions() {
            try {
                const res = await fetch('/api/sessions');
                const sessions = await res.json();
                const list = document.getElementById('session-list');
                list.innerHTML = ''; // Listeyi temizle

                sessions.forEach(session => {
                    const div = document.createElement('div');
                    div.id = `session-${session.id}`; // ID atamasƒ± √∂nemli (Se√ßim i√ßin)
                    div.className = `group flex items-center justify-between p-3 rounded-lg hover:bg-white/5 cursor-pointer transition text-sm text-gray-400 select-none`;
                    
                    // Eƒüer ≈üu anki aktif sohbet ise boya
                    if (session.id === currentSessionId) {
                        div.classList.add('active-session');
                    }

                    div.innerHTML = `
                        <span onclick="loadChat(${session.id}, '${session.title.replace(/'/g, "\\'")}')" class="truncate flex-1">${session.title}</span>
                        <button onclick="deleteSession(${session.id}, event)" class="opacity-0 group-hover:opacity-100 text-red-400 hover:bg-white/10 p-1 rounded transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    `;
                    list.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }

        async function loadChat(id, title = "Sohbet") {
            // Aynƒ± sohbete tekrar tƒ±klanƒ±rsa i≈ülem yapma
            if (currentSessionId === id) {
                 if(window.innerWidth < 768) toggleSidebar(); // Mobildeyse kapat
                 return;
            }

            currentSessionId = id;
            document.getElementById('header-title').innerText = title;

            // 1. UI G√ºncelleme (Listeyi silmeden sadece aktifi boya)
            highlightActiveSession(id);

            // 2. Chat Alanƒ±nƒ± Temizle
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            
            // 3. Ho≈ügeldin ekranƒ±nƒ± gizle
            const ws = document.getElementById('welcome-screen');
            if(ws) ws.style.display = 'none';

            // 4. Mobilde Sidebar'ƒ± kapat
            if(window.innerWidth < 768) toggleSidebar();

            // 5. Mesajlarƒ± √áek
            try {
                // Y√ºkleniyor animasyonu ekle
                chatBox.innerHTML = '<div class="flex justify-center pt-10"><span class="animate-spin text-2xl">‚è≥</span></div>';
                
                const res = await fetch(`/api/session/${id}`);
                const messages = await res.json();
                
                chatBox.innerHTML = ''; // Loader'ƒ± sil
                
                if (messages.length === 0) {
                     // Bo≈ü sohbet (Hata durumunda vs.)
                     chatBox.innerHTML = '<div class="text-center text-gray-500 mt-10">Mesaj bulunamadƒ±.</div>';
                }

                messages.forEach(msg => appendMessage(msg.role, msg.content, false));
                scrollToBottom();

            } catch (e) {
                chatBox.innerHTML = '<div class="text-center text-red-400 mt-10">Sohbet y√ºklenirken hata olu≈ütu.</div>';
            }
        }

        function highlightActiveSession(id) {
            // T√ºm aktif sƒ±nƒ±flarƒ± kaldƒ±r
            document.querySelectorAll('#session-list > div').forEach(div => {
                div.classList.remove('active-session');
            });
            // Yeni se√ßilene ekle
            const activeDiv = document.getElementById(`session-${id}`);
            if (activeDiv) activeDiv.classList.add('active-session');
        }

        function startNewChat() {
            currentSessionId = null;
            document.getElementById('header-title').innerText = "Yeni Sohbet";
            
            // Aktif se√ßimi kaldƒ±r
            document.querySelectorAll('#session-list > div').forEach(div => div.classList.remove('active-session'));

            document.getElementById('chat-box').innerHTML = `
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center space-y-6 opacity-80">
                    <div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center text-3xl border border-white/5">‚ú®</div>
                    <h2 class="text-xl font-bold text-white">Yeni Sohbet</h2>
                </div>`;
            
            if(window.innerWidth < 768) toggleSidebar();
        }

        async function deleteSession(id, event) {
            event.stopPropagation();
            if(confirm('Bu sohbet silinsin mi?')) {
                await fetch(`/api/session/${id}`, { method: 'DELETE' });
                if(currentSessionId === id) startNewChat();
                loadSessions(); // Listeyi yenilemek zorundayƒ±z √ß√ºnk√º eleman azaldƒ±
            }
        }

        // --- MESAJLA≈ûMA ---

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.style.height = 'auto';
            
            const ws = document.getElementById('welcome-screen');
            if(ws) ws.style.display = 'none';

            appendMessage('user', message);

            const chatBox = document.getElementById('chat-box');
            const loading = document.createElement('div');
            loading.id = 'loading';
            loading.className = 'p-4 flex gap-1';
            loading.innerHTML = '<span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-100"></span><span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-200"></span>';
            chatBox.appendChild(loading);
            scrollToBottom();

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, session_id: currentSessionId })
                });
                const data = await res.json();
                document.getElementById('loading').remove();
                
                // Eƒüer bu yeni bir sohbetse listeyi g√ºncelle
                if (data.session_id && data.new_session) {
                    currentSessionId = data.session_id;
                    document.getElementById('header-title').innerText = data.title;
                    await loadSessions(); // Listeyi yenile
                    highlightActiveSession(currentSessionId); // Yeni geleni se√ßili yap
                }
                
                appendMessage('assistant', data.response);
            } catch (e) {
                if(document.getElementById('loading')) document.getElementById('loading').remove();
                appendMessage('assistant', '‚ö†Ô∏è Bir hata olu≈ütu.');
            }
        }

        function appendMessage(role, content, animate = true) {
            const chatBox = document.getElementById('chat-box');
            const isBot = role === 'assistant';
            const div = document.createElement('div');
            div.className = `flex ${isBot ? 'justify-start' : 'justify-end'} ${animate ? 'animate-fade-in' : ''}`;
            
            const html = marked.parse(content);
            div.innerHTML = `
                <div class="max-w-[95%] md:max-w-[80%] rounded-2xl p-4 md:p-5 ${isBot ? 'bg-transparent' : 'bg-[#27272a] shadow-md'} text-gray-200">
                    ${isBot ? '<div class="text-xs font-bold text-indigo-400 mb-2">CLAUDE</div>' : ''}
                    <div class="prose prose-invert max-w-none text-[15px] leading-relaxed">${html}</div>
                </div>`;
            
            chatBox.appendChild(div);
            if(isBot) addCopyButtons(div);
            scrollToBottom();
        }

        function addCopyButtons(element) {
            element.querySelectorAll('pre').forEach(pre => {
                if(pre.querySelector('.copy-btn')) return;
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.innerText = 'Kopyala';
                btn.onclick = (e) => {
                    e.stopPropagation(); // Butona basƒ±nca ba≈üka event tetikleme
                    navigator.clipboard.writeText(pre.innerText);
                    btn.innerText = '‚úì';
                    setTimeout(() => btn.innerText = 'Kopyala', 2000);
                };
                pre.appendChild(btn);
            });
        }

        function scrollToBottom() {
            const cb = document.getElementById('chat-box');
            cb.scrollTop = cb.scrollHeight;
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sb.classList.toggle('sidebar-closed');
            sb.classList.toggle('sidebar-open');
            overlay.classList.toggle('hidden');
        }

        window.onload = loadSessions;

        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
    </script>
</body>
</html>
